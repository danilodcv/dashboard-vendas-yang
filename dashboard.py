import streamlit as st
import pandas as pd
import datetime
from babel.numbers import format_currency

# --- Configura√ß√£o da P√°gina ---
st.set_page_config(
    page_title="Dashboard de Vendas - YANG Molduras",
    page_icon="üìà",
    layout="wide"
)

# --- Fun√ß√µes Auxiliares ---
def formatar_moeda(valor):
    """Formata um n√∫mero para o padr√£o de moeda brasileira (R$ 1.234,56) usando Babel."""
    return format_currency(valor, 'BRL', locale='pt_BR')

def converter_para_float(valor):
    """Converte um valor (possivelmente string no formato pt-BR) para float de forma segura."""
    if isinstance(valor, str):
        # Remove pontos de milhar, substitui v√≠rgula decimal por ponto
        valor_limpo = valor.replace('.', '').replace(',', '.')
        try:
            return float(valor_limpo)
        except (ValueError, TypeError):
            return 0.0  # Retorna 0 se a convers√£o falhar
    elif isinstance(valor, (int, float)):
        return float(valor)  # Retorna o valor se j√° for num√©rico
    return 0.0  # Retorna 0 para outros tipos inesperados

# --- Carregamento e Cache de Dados ---
@st.cache_data
def carregar_dados():
    """
    Carrega os dados da planilha usando 'converters' para tratar corretamente os formatos
    num√©ricos brasileiros diretamente na leitura.
    """
    try:
        colunas_para_converter = {
            'quantidade': converter_para_float,
            'vlr_unitario': converter_para_float,
            'vlr_final': converter_para_float
        }
        
        df = pd.read_excel(
            "vendas.xlsx",
            converters=colunas_para_converter
        )
        
        df['emissao'] = pd.to_datetime(df['emissao'], dayfirst=True, errors='coerce')
        df.dropna(subset=['emissao'], inplace=True)
        
        # Garante que as colunas de valor que n√£o foram convertidas sejam num√©ricas
        for col in ['quantidade', 'vlr_unitario', 'vlr_final']:
             if col not in colunas_para_converter and col in df.columns:
                 df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)

        # Recalcula o valor total para garantir consist√™ncia
        df['vlr_total_produto'] = df['quantidade'] * df['vlr_unitario']
            
        df['codigo'] = df['codigo'].astype(str)
        return df
    except FileNotFoundError:
        st.error("Arquivo 'vendas.xlsx' n√£o encontrado. Verifique se ele est√° na pasta do projeto.")
        return None
    except Exception as e:
        st.error(f"Erro ao carregar ou processar a planilha: {e}")
        return None

df_original = carregar_dados()

# --- Interface Principal ---
if df_original is not None:
    # --- Barra Lateral com Logo e Filtros Unificados ---
    st.sidebar.title("YANG Molduras")
    try:
        st.sidebar.image("sua_logo.png", use_container_width=True)
    except Exception:
        st.sidebar.warning("Logo n√£o encontrada.")
    
    st.sidebar.markdown("---")
    st.sidebar.header("Filtros de Vendas")

    # --- Filtro de Per√≠odo ---
    todo_periodo = st.sidebar.checkbox("Analisar todo o per√≠odo", value=True)
    
    min_date = df_original['emissao'].min().date()
    max_date = df_original['emissao'].max().date()

    if todo_periodo:
        data_inicial = min_date
        data_final = max_date
    else:
        data_inicial = st.sidebar.date_input("Data Inicial", min_date, min_value=min_date, max_value=max_date)
        data_final = st.sidebar.date_input("Data Final", max_date, min_value=min_date, max_value=max_date)

    # --- Filtro de C√≥digo do Produto ---
    lista_codigos = sorted(df_original['codigo'].unique())
    lista_codigos.insert(0, "Todos os C√≥digos")
    codigo_selecionado = st.sidebar.selectbox("C√≥digo do Produto:", options=lista_codigos)

    # --- Aplica√ß√£o dos Filtros ---
    df_filtrado = df_original.copy()
    
    if not todo_periodo:
        if data_inicial > data_final:
            st.sidebar.error("A data inicial n√£o pode ser maior que a data final.")
            st.stop()
        else:
            data_inicial_ts = pd.to_datetime(data_inicial)
            data_final_ts = pd.to_datetime(data_final)
            df_filtrado = df_filtrado[df_filtrado['emissao'].dt.date.between(data_inicial, data_final, inclusive='both')]


    if codigo_selecionado != "Todos os C√≥digos":
        df_filtrado = df_filtrado[df_filtrado['codigo'] == codigo_selecionado]

    # --- Conte√∫do Principal ---
    st.title("üìà Dashboard Anal√≠tico de Vendas")
    st.markdown("---")

    if df_filtrado.empty:
        st.warning("Nenhum dado encontrado para os filtros selecionados.")
    else:
        st.subheader("Resumo do Per√≠odo Filtrado")
        total_vendas = df_filtrado['vlr_total_produto'].sum()
        num_pedidos = df_filtrado['pedido'].nunique()

        col1, col2 = st.columns(2)
        
        col1.metric("Valor Total das Vendas", formatar_moeda(total_vendas))
        col2.metric("Quantidade de Pedidos", f"{num_pedidos}")
        
        st.markdown("---")
        
        st.subheader("Detalhes das Vendas")
        
        colunas_mostrar = ['pedido', 'emissao', 'cliente', 'codigo', 'produto', 'vlr_total_produto']
        df_display = df_filtrado[colunas_mostrar].rename(columns={
            'pedido': 'N¬∫ Pedido',
            'emissao': 'Data da Venda',
            'cliente': 'Cliente',
            'codigo': 'C√≥digo',
            'produto': 'Produto',
            'vlr_total_produto': 'Valor Total'
        }).sort_values(by="Data da Venda", ascending=False)

        # Formata√ß√£o profissional via st.column_config
        st.dataframe(
            df_display,
            use_container_width=True,
            hide_index=True,
            column_config={
                "Data da Venda": st.column_config.DateColumn(
                    "Data da Venda",
                    format="DD/MM/YYYY"
                ),
                "Valor Total": st.column_config.NumberColumn(
                    "Valor Total (R$)",
                    format="%.2f"
                )
            }
        )

    st.markdown("\n\n---\n\n")

    st.subheader("Consulta R√°pida por Cliente")
    cliente_pesquisado = st.text_input("Digite o nome do cliente para uma busca r√°pida:")

    if cliente_pesquisado:
        # Busca por cliente mais segura com regex=False
        compras_cliente = df_original[df_original['cliente'].str.contains(cliente_pesquisado, case=False, na=False, regex=False)]

        if not compras_cliente.empty:
            st.success(f"üîç Exibindo compras para clientes contendo '{cliente_pesquisado}':")
            st.dataframe(
                compras_cliente,
                use_container_width=True,
                hide_index=True,
                 column_config={
                    "emissao": st.column_config.DateColumn("Data da Venda", format="DD/MM/YYYY"),
                    "vlr_total_produto": st.column_config.NumberColumn("Valor Total (R$)", format="%.2f"),
                    "vlr_unitario": st.column_config.NumberColumn("Valor Unit√°rio (R$)", format="%.2f"),
                    "vlr_final": st.column_config.NumberColumn("Valor Final (R$)", format="%.2f")
                }
            )
        else:
            st.warning("Nenhum cliente encontrado com este nome.")

